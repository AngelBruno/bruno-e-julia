import{c as v,d as m,g as x,q as g,o as p,a as w,s as u,b as E,e as f,u as b,i as B,f as q,h as C}from"./firebase-config-CYVDa9ry.js";let i=[];async function D(){try{const t=v(m,"mesas"),o=await x(t);return!0}catch(t){return console.error("Firebase connection failed:",t),!1}}async function k(){try{const t=v(m,"mesas"),o=g(t,p("chaves","desc")),e=w(o,s=>{i=[],s.forEach(a=>{var r;const n={id:parseInt(a.id),...a.data(),ultimaAtualizacao:((r=a.data().ultimaAtualizacao)==null?void 0:r.toDate())||new Date};i.push(n)}),R(),A(),K()});window.mesasUnsubscribe=e}catch(t){console.error("❌ Error setting up mesas listener:",t)}}async function L(){try{const t=v(m,"historico","bV3oggvLWnbtvuxWtwws","registros"),o=g(t,p("dataHora","desc"));w(o,e=>{const s=[];e.forEach(a=>{s.push(a.data())}),T(s)})}catch(t){console.error("❌ Error setting up historico listener:",t)}}async function $(t,o){try{const e={nome:o,chaves:0,ultimaAtualizacao:u()};return await E(f(m,"mesas",t.toString()),e),d(`Mesa "${o}" criada com sucesso!`,"success"),!0}catch(e){return console.error("Error creating mesa:",e),d("Erro ao criar mesa: "+e.message,"error"),!1}}async function S(t,o){try{const e=i.find(n=>n.id===t);if(!e)throw new Error("Mesa não encontrada");const s=t>9?t.toString():"0"+t.toString(),a=f(m,"mesas",s);return await b(a,{chaves:B(o),ultimaAtualizacao:u()}),await M({mesaId:s,mesaNome:e.nome,quantidade:o,motivo:"Adição de chaves",dataHora:u()}),d(`${o} chaves adicionadas!`,"success"),closeModal("add-keys-modal"),!0}catch(e){return console.error("Error adding keys:",e),d("Erro ao adicionar chaves: "+e.message,"error"),!1}}async function H(t,o,e){try{const s=i.find(c=>c.id===t);if(!s)throw new Error("Mesa não encontrada");const a=s.chaves-o;if(a<0)throw new Error("Quantidade insuficiente de chaves na mesa");const n=t>9?t.toString():"0"+t.toString(),r=f(m,"mesas",n);return await b(r,{chaves:a,ultimaAtualizacao:u()}),await M({mesaId:n,mesaNome:s.nome||"Unknown",quantidade:-o,motivo:e||"Remoção de chaves",dataHora:u()}),d(`${o} chaves removidas!`,"success"),closeModal("remove-keys-modal"),!0}catch(s){return console.error("Error removing keys:",s),d("Erro ao remover chaves: "+s.message,"error"),!1}}async function M(t){try{const o=f(m,"historico","bV3oggvLWnbtvuxWtwws");(await q(o)).exists()||await E(o,{}),console.log("Adding to history:",t),await C(v(o,"registros"),t),console.log("Successfully added to history.")}catch(o){console.warn("Could not add to history:",o.message)}}function R(){const t=document.getElementById("mesas-container");if(!t)return;t.innerHTML="",[...i].sort((e,s)=>e.id-s.id).forEach((e,s)=>{const a=document.createElement("div");a.className="mesa-item",a.innerHTML=`
            <div class="mesa-info">
                <div class="mesa-nome">${e.nome}</div>
                <div class="mesa-chaves">${e.chaves} chaves</div>
            </div>
            <div class="mesa-actions">
                <button class="btn btn-sm btn-success" onclick="quickAddKeys(${e.id})">
                    ➕ Chaves
                </button>
                <button class="btn btn-sm btn-danger" onclick="quickRemoveKeys(${e.id})">
                    ➖ Chaves
                </button>
            </div>
        `,t.appendChild(a)})}function T(t){const o=document.getElementById("historico-tbody");o&&(o.innerHTML="",t.forEach(e=>{var c;const s=(c=e.dataHora)!=null&&c.toDate?e.dataHora.toDate().toLocaleString("pt-BR"):"Carregando...",a=e.quantidade>0?"positivo":"negativo",n=e.quantidade>0?`+${e.quantidade}`:e.quantidade,r=`
            <tr>
                <td>${e.mesaNome} (ID: ${e.mesaId})</td>
                <td class="${a}">${n}</td>
                <td>${e.motivo}</td>
                <td>${s}</td>
            </tr>
        `;o.innerHTML+=r}))}function A(){["add-mesa-select","remove-mesa-select"].forEach(o=>{const e=document.getElementById(o);e&&(e.innerHTML='<option value="">Selecione uma mesa</option>',i.forEach(s=>{const a=document.createElement("option");a.value=s.id,a.textContent=`${s.nome} (${s.chaves} chaves)`,e.appendChild(a)}))})}function K(){const t=i.reduce((r,c)=>r+c.chaves,0),o=i.length,e=Math.max(0,1e3-t),s=document.getElementById("total-chaves"),a=document.getElementById("total-mesas"),n=document.getElementById("chaves-restantes");s&&(s.textContent=t),a&&(a.textContent=o),n&&(n.textContent=e)}function d(t,o="info"){const e=document.createElement("div");e.style.cssText=`
        position: fixed; top: 20px; right: 20px; z-index: 1001;
        background: ${o==="error"?"#dc3545":"#28a745"}; 
        color: white; padding: 15px 20px;
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 300px; word-wrap: break-word;
    `,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e)},o==="error"?5e3:3e3)}window.sortearNumero=()=>{const t=i.reduce((e,s)=>e+s.chaves,0),o=Math.floor(Math.random()*t)+1;document.getElementById("resultado-sorteio").textContent=o};window.quickAddKeys=t=>{document.getElementById("add-mesa-select").value=t,document.getElementById("add-quantidade").value="",openModal("add-keys-modal")};window.quickRemoveKeys=t=>{document.getElementById("remove-mesa-select").value=t,document.getElementById("remove-quantidade").value="",openModal("remove-keys-modal")};window.openModal=t=>{const o=document.getElementById(t);o&&(o.style.display="block")};window.closeModal=t=>{const o=document.getElementById(t);o&&(o.style.display="none")};document.addEventListener("DOMContentLoaded",async()=>{await D()?(await k(),await L()):d("Firebase não configurado. Configure o Firestore para usar o sistema.","error");const o=document.getElementById("nova-mesa-form");o?o.addEventListener("submit",async a=>{a.preventDefault();const n=document.getElementById("mesa-id"),r=document.getElementById("mesa-nome"),c=n==null?void 0:n.value,l=r==null?void 0:r.value,y=parseInt(c),h=l==null?void 0:l.trim();if(!y||!h){d("Preencha todos os campos","error");return}if(i.find(I=>I.id===y)){d("Mesa com este ID já existe","error");return}await $(y,h)&&o.reset()}):console.error('❌ Form "nova-mesa-form" not found!');const e=document.getElementById("add-keys-form");e&&e.addEventListener("submit",async a=>{a.preventDefault();const n=parseInt(document.getElementById("add-mesa-select").value),r=parseInt(document.getElementById("add-quantidade").value);if(!n||!r){d("Selecione mesa e quantidade","error");return}await S(n,r)&&e.reset()});const s=document.getElementById("remove-keys-form");s&&s.addEventListener("submit",async a=>{a.preventDefault();const n=parseInt(document.getElementById("remove-mesa-select").value),r=parseInt(document.getElementById("remove-quantidade").value),c=document.getElementById("remove-motivo").value.trim();if(!n||!r){d("Selecione mesa e quantidade","error");return}await H(n,r,c)&&s.reset()}),window.addEventListener("click",a=>{a.target.classList.contains("modal")&&(a.target.style.display="none")})});
